!function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,i){var a=(new Date).getTime(),n=Math.max(0,16-(a-t)),s=window.setTimeout(function(){e(a+n)},n);return t=a+n,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}();var Game=new function(){var t=[];this.initialize=function(t,e,i){return this.canvas=document.getElementById(t),this.playerOffset=10,this.canvasMultiplier=1,this.setupMobile(),this.width=this.canvas.width,this.height=this.canvas.height,this.ctx=this.canvas.getContext&&this.canvas.getContext("2d"),this.ctx?(this.setupInput(),this.loop(),this.mobile&&this.setBoard(4,new TouchControls),void SpriteSheet.load(e,i)):alert("Please upgrade your browser to play")};var e={37:"left",39:"right",32:"fire"};this.keys={},this.setupInput=function(){window.addEventListener("keydown",function(t){e[t.keyCode]&&(Game.keys[e[t.keyCode]]=!0,t.preventDefault())},!1),window.addEventListener("keyup",function(t){e[t.keyCode]&&(Game.keys[e[t.keyCode]]=!1,t.preventDefault())},!1)};var i=(new Date).getTime(),a=1/30;this.loop=function(){var e=(new Date).getTime();requestAnimationFrame(Game.loop);var n=(e-i)/1e3;n>a&&(n=a);for(var s=0,r=t.length;r>s;s++)t[s]&&(t[s].step(n),t[s].draw(Game.ctx));i=e},this.setBoard=function(e,i){t[e]=i},this.setupMobile=function(){var t=document.getElementById("container"),e=!!("ontouchstart"in window),i=window.innerWidth,a=window.innerHeight;return e&&(this.mobile=!0),screen.width>=1280||!e?!1:(i>a&&(alert("Please rotate the device and then click OK"),i=window.innerWidth,a=window.innerHeight),t.style.height=2*a+"px",window.scrollTo(0,1),a=window.innerHeight+2,t.style.height=a+"px",t.style.width=i+"px",t.style.padding=0,a>=1.75*this.canvas.height||i>=1.75*this.canvas.height?(this.canvasMultiplier=2,this.canvas.width=i/2,this.canvas.height=a/2,this.canvas.style.width=i+"px",this.canvas.style.height=a+"px"):(this.canvas.width=i,this.canvas.height=a),this.canvas.style.position="absolute",this.canvas.style.left="0px",void(this.canvas.style.top="0px"))}},SpriteSheet=new function(){return this.map={},this.load=function(t,e){this.map=t,this.image=new Image,this.image.onload=e,this.image.src="../../demos/gearinvasion/images/sprites.png"},this.draw=function(t,e,i,a,n){var s=this.map[e];n||(n=0),t.drawImage(this.image,s.sx+n*s.w,s.sy,s.w,s.h,Math.floor(i),Math.floor(a),s.w,s.h)},this},TitleScreen=function(t,e,i){var a=!1;this.step=function(t){Game.keys.fire||(a=!0),a&&Game.keys.fire&&i&&i()},this.draw=function(i){i.fillStyle="#edd21e",i.font="bold 40px bangers";var a=i.measureText(t);i.fillText(t,Game.width/2-a.width/2,Game.height/2),i.fillStyle="#FFFFFF",i.font="bold 20px bangers";var n=i.measureText(e);i.fillText(e,Game.width/2-n.width/2,Game.height/2+40)}},GameBoard=function(){var t=this;this.objects=[],this.cnt={},this.add=function(t){return t.board=this,this.objects.push(t),this.cnt[t.type]=(this.cnt[t.type]||0)+1,t},this.remove=function(t){var e=this.removed.indexOf(t);return-1==e?(this.removed.push(t),!0):!1},this.resetRemoved=function(){this.removed=[]},this.finalizeRemoved=function(){for(var t=0,e=this.removed.length;e>t;t++){var i=this.objects.indexOf(this.removed[t]);-1!=i&&(this.cnt[this.removed[t].type]--,this.objects.splice(i,1))}},this.iterate=function(t){for(var e=Array.prototype.slice.call(arguments,1),i=0,a=this.objects.length;a>i;i++){var n=this.objects[i];n[t].apply(n,e)}},this.detect=function(t){for(var e=0,i=this.objects.length;i>e;e++)if(t.call(this.objects[e]))return this.objects[e];return!1},this.step=function(t){this.resetRemoved(),this.iterate("step",t),this.finalizeRemoved()},this.draw=function(t){this.iterate("draw",t)},this.overlap=function(t,e){return!(t.y+t.h-1<e.y||t.y>e.y+e.h-1||t.x+t.w-1<e.x||t.x>e.x+e.w-1)},this.collide=function(e,i){return this.detect(function(){if(e!=this){var a=(!i||this.type&i)&&t.overlap(e,this);return a?this:!1}})}},Sprite=function(){};Sprite.prototype.setup=function(t,e){this.sprite=t,this.merge(e),this.frame=this.frame||0,this.w=SpriteSheet.map[t].w,this.h=SpriteSheet.map[t].h},Sprite.prototype.merge=function(t){if(t)for(var e in t)this[e]=t[e]},Sprite.prototype.draw=function(t){SpriteSheet.draw(t,this.sprite,this.x,this.y,this.frame)},Sprite.prototype.hit=function(t){this.board.remove(this)};var Level=function(t,e){this.levelData=[];for(var i=0;i<t.length;i++)this.levelData.push(Object.create(t[i]));this.t=0,this.callback=e};Level.prototype.step=function(t){var e=0,i=[],a=null;for(this.t+=1e3*t;(a=this.levelData[e])&&a[0]<this.t+2e3;){if(this.t>a[1])i.push(a);else if(a[0]<this.t){var n=enemies[a[3]],s=a[4];this.board.add(new Enemy(n,s)),a[0]+=a[2]}e++}for(var r=0,h=i.length;h>r;r++){var o=this.levelData.indexOf(i[r]);-1!=o&&this.levelData.splice(o,1)}0===this.levelData.length&&0===this.board.cnt[OBJECT_ENEMY]&&this.callback&&this.callback()},Level.prototype.draw=function(t){};var TouchControls=function(){var t=10,e=Game.width/5,i=e-t;this.drawSquare=function(t,a,n,s,r){t.globalAlpha=r?.9:.6,t.fillStyle="#CCC",t.fillRect(a,n,i,i),t.fillStyle="#FFF",t.globalAlpha=1,t.font="bold "+3*e/4+"px arial";var h=t.measureText(s);t.fillText(s,a+i/2-h.width/2,n+3*i/4+5)},this.draw=function(i){i.save();var a=Game.height-e;this.drawSquare(i,t,a,"\u25c0",Game.keys.left),this.drawSquare(i,e+t,a,"\u25b6",Game.keys.right),this.drawSquare(i,4*e,a,"\u25ce",Game.keys.fire),i.restore()},this.step=function(t){},this.trackTouch=function(t){var i,a;t.preventDefault(),Game.keys.left=!1,Game.keys.right=!1;for(var n=0;n<t.targetTouches.length;n++)i=t.targetTouches[n],a=i.pageX/Game.canvasMultiplier-Game.canvas.offsetLeft,e>a&&(Game.keys.left=!0),a>e&&2*e>a&&(Game.keys.right=!0);if("touchstart"==t.type||"touchend"==t.type)for(n=0;n<t.changedTouches.length;n++)i=t.changedTouches[n],a=i.pageX/Game.canvasMultiplier-Game.canvas.offsetLeft,a>4*e&&(Game.keys.fire="touchstart"==t.type)},Game.canvas.addEventListener("touchstart",this.trackTouch,!0),Game.canvas.addEventListener("touchmove",this.trackTouch,!0),Game.canvas.addEventListener("touchend",this.trackTouch,!0),Game.canvas.addEventListener("dblclick",function(t){t.preventDefault()},!0),Game.canvas.addEventListener("click",function(t){t.preventDefault()},!0),Game.playerOffset=e+20},GamePoints=function(){Game.points=0;var t=8;this.draw=function(e){e.save(),e.font="bold 18px arial",e.fillStyle="#FFFFFF";for(var i=""+Game.points,a=t-i.length,n="";a-->0;)n+="0";e.fillText(n+i,10,20),e.restore()},this.step=function(t){}};